{"title":"GitLab CI/CD 实现自动构建部署项目","uid":"e42cdbfca7d3b003c339c6ab5827f117","slug":"gitlab-cicd","date":"2019-12-22T02:48:00.000Z","updated":"2020-01-04T09:18:24.000Z","comments":true,"path":"api/articles/gitlab-cicd.json","keywords":"Stephen web3","cover":"https://i.loli.net/2019/12/30/JFR8AZQ2EO9LUp4.jpg","content":"<link rel=\"stylesheet\" href=\"/owl.css\"><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h1 id=\"一、环境准备\"><a href=\"#一、环境准备\" class=\"headerlink\" title=\"一、环境准备\"></a>一、环境准备</h1><p>首先需要有一台 GitLab 服务器，然后需要有个项目；这里示例项目以 Spring Boot 项目为例，然后最好有一台专门用来 Build 的机器，实际生产中如果 Build 任务不频繁可适当用一些业务机器进行 Build。</p>\n<ul>\n<li>GitLab IP :10.88.9.21  (version 12.6.0)</li>\n<li>Runner IP :10.88.9.37  (version 12.5.0)</li>\n</ul>\n<h1 id=\"二、GitLab-CI-简介\"><a href=\"#二、GitLab-CI-简介\" class=\"headerlink\" title=\"二、GitLab CI 简介\"></a>二、GitLab CI 简介</h1><p>GitLab CI 是 GitLab 默认集成的 CI 功能，GitLab CI 通过在项目内 .gitlab-ci.yaml 配置文件读取 CI 任务并进行相应处理；GitLab CI 通过其称为 GitLab Runner 的 Agent 端进行 build 操作；Runner 本身可以使用多种方式安装，比如使用 Docker 镜像启动等；Runner 在进行 build 操作时也可以选择多种 build 环境提供者；比如直接在 Runner 所在宿主机 build、通过新创建虚拟机(vmware、virtualbox)进行 build等；同时 Runner 支持 Docker 作为 build 提供者，即每次 build 新启动容器进行 build；GitLab CI 其大致架构如下<br><img src=\"https://stblogs.oss-cn-chengdu.aliyuncs.com/UTOOLS1576566686625.png\" alt=\"UTOOLS1576566686625.png\"></p>\n<h1 id=\"三、GitLab搭建\"><a href=\"#三、GitLab搭建\" class=\"headerlink\" title=\"三、GitLab搭建\"></a>三、GitLab搭建</h1><h2 id=\"安准基础依赖\"><a href=\"#安准基础依赖\" class=\"headerlink\" title=\"安准基础依赖\"></a>安准基础依赖</h2><ul>\n<li>安装基础依赖</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">sudo yum install -y curl policycoreutils-python openssh-server</code></pre>\n<p>启动ssh服务&amp;设置为开机启动</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">sudo systemctl enable sshd\nsudo systemctl start sshd </code></pre>\n<ul>\n<li>安装Postfix</li>\n</ul>\n<p>Postfix是一个邮件服务器，GitLab发送邮件需要用到</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 安装postfix\nsudo yum install -y postfix</code></pre>\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 启动postfix并设置为开机启动\nsudo systemctl enable postfix\nsudo systemctl start postfix</code></pre>\n<ul>\n<li>开放ssh以及http服务（80端口)</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 开放ssh、http服务\nsudo firewall-cmd --add-service&#x3D;ssh --permanent\nsudo firewall-cmd --add-service&#x3D;http --permanent</code></pre>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 重载防火墙规则\nsudo firewall-cmd --reload</code></pre>\n<h2 id=\"安装GitLab\"><a href=\"#安装GitLab\" class=\"headerlink\" title=\"安装GitLab\"></a>安装GitLab</h2><p>本次我们部署的是社区版:gitlab-ce，如果要部署商业版可以把关键字替换为：gitlab-ee</p>\n<ul>\n<li>Yum安装GitLab</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 新建 &#x2F;etc&#x2F;yum.repos.d&#x2F;gitlab-ce.repo，内容为\n[gitlab-ce]\nname&#x3D;Gitlab CE Repository\nbaseurl&#x3D;https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;gitlab-ce&#x2F;yum&#x2F;el$releasever&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n# 再执行\nsudo yum makecache\nsudo yum install gitlab-ce</code></pre>\n<h2 id=\"配置GitLab\"><a href=\"#配置GitLab\" class=\"headerlink\" title=\"配置GitLab\"></a>配置GitLab</h2><p>GitLab默认的配置文件路径是&#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">#修改配置文件\nsudo vim &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb\n#配置首页地址（大约在第15行）可以用IP代替域名，这里根据自己需求来即可\nexternal_url &#39;http:&#x2F;&#x2F;gitlab.ecloud.com&#39;</code></pre>\n<h2 id=\"启动并访问GitLab\"><a href=\"#启动并访问GitLab\" class=\"headerlink\" title=\"启动并访问GitLab\"></a>启动并访问GitLab</h2><ul>\n<li>启动GitLab</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">#重新配置并启动\nsudo gitlab-ctl reconfigure\n#完成后将会看到如下输出\nRunning handlers complete\nChef Client finished, 432&#x2F;613 resources updated in 03 minutes 43 seconds\ngitlab Reconfigured!</code></pre>\n<ul>\n<li>访问 GitLab</li>\n</ul>\n<p><code>将设置的域名DNS解析到服务器IP，或者修改本地host将域名指向服务器IP。 访问：http://gitlab.ecloud.com </code></p>\n<ul>\n<li>设置密码</li>\n</ul>\n<p><code>这时候会提示为管理员账号设置密码。管理员账号默认username是root。 设置完成之后即可使用root账号登录，登陆后会进入欢迎界面。</code><br><img src=\"https://stblogs.oss-cn-chengdu.aliyuncs.com/UTOOLS1576569027584.png\" alt=\"UTOOLS1576569027584.png\"></p>\n<h1 id=\"四、GitLab-CI-配置\"><a href=\"#四、GitLab-CI-配置\" class=\"headerlink\" title=\"四、GitLab CI 配置\"></a>四、GitLab CI 配置</h1><h2 id=\"增加-Runner\"><a href=\"#增加-Runner\" class=\"headerlink\" title=\"增加 Runner\"></a>增加 Runner</h2><p><em>GitLab CI 在进行构建时会将任务下发给 Runner，让 Runner 去执行；所以先要添加一个 Runner</em></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 新建 &#x2F;etc&#x2F;yum.repos.d&#x2F;gitlab-runner.repo，内容为\n[gitlab-runner]\nname&#x3D;gitlab-runner\nbaseurl&#x3D;https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;gitlab-runner&#x2F;yum&#x2F;el7\nrepo_gpgcheck&#x3D;0\ngpgcheck&#x3D;0\nenabled&#x3D;1\ngpgkey&#x3D;https:&#x2F;&#x2F;packages.gitlab.com&#x2F;gpg.key\n# 再执行\nsudo yum makecache\nsudo yum install gitlab-runner</code></pre>\n<h2 id=\"gitlab-runner-注册\"><a href=\"#gitlab-runner-注册\" class=\"headerlink\" title=\"gitlab-runner 注册\"></a>gitlab-runner 注册</h2><ul>\n<li><p>首先要先获取gitlab-ci的Token:<br><code>项目主页 -&gt; Sttings -&gt; CI/CD -&gt; Runners Expand </code><br><img src=\"https://stblogs.oss-cn-chengdu.aliyuncs.com/UTOOLS1577171080231.png\" alt=\"UTOOLS1577171080231.png\"></p>\n</li>\n<li><p>登录安装runner的服务器，使用命令注册gitlab-runner:</p>\n</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">gitlab-runner register</code></pre>\n\n<ol>\n<li>输入gitlab的服务URL，这个使用的是<a href=\"http://gitlab.ecloud.com/\">http://gitlab.ecloud.com</a></li>\n<li>输入gitlab-ci的Toekn，获取方式参考上图</li>\n<li>关于集成服务中对于这个runner的描述</li>\n<li>给这个gitlab-runner输入一个标记，这个tag非常重要，在后续的使用过程中需要使用这个tag来指定gitlab-runner</li>\n<li>是否运行在没有tag的build上面。在配置gitlab-ci的时候，会有很多job，每个job可以通过tags属性来选择runner。这里为true表示如果job没有配置tags，也执行</li>\n<li>是否锁定runner到当前项目</li>\n<li>选择执行器，gitlab-runner实现了很多执行器，可用在不同场景中运行构建，详情可见GitLab Runner Executors，这里选用Shell模式</li>\n<li>刷新页面就可以看到新增的一个Runner:</li>\n</ol>\n<p><img src=\"https://stblogs.oss-cn-chengdu.aliyuncs.com/UTOOLS1577172646072.png\" alt=\"UTOOLS1577172646072.png\"></p>\n<p> 9.这个GitLabRunner就安装好了，下一步就是把项目集成到gitlab-ci中，开始持续集成了。</p>\n<h2 id=\"gitlab-runner-使用\"><a href=\"#gitlab-runner-使用\" class=\"headerlink\" title=\"gitlab-runner 使用\"></a>gitlab-runner 使用</h2><ul>\n<li>创建 CI 配置文件<br><code>一切准备就绪以后，就可以编写 CI 脚本了；GitLab 依靠读取项目根目录下的 .gitlab-ci.yml 文件来执行相应的 CI 操作；以下为测试项目的 .gitlab-ci.yml 配置</code></li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"># These are the default stages. You don&#39;t need to explicitly define them. But you could define any stages you need.\nstages:\n- build\n- deploy\n- catLog\n- kill\n\nvariables:\nMAVEN_CLI_OPTS: &quot;-s .m2&#x2F;settings.xml --batch-mode&quot;\nMAVEN_OPTS: &quot;-Dmaven.repo.local&#x3D;&#x2F;export&#x2F;servers&#x2F;repository_boot&quot;\nSHELL_NAME: &quot;ry.sh&quot;\ncache:\npaths:\n# - .m2&#x2F;repository\n- target&#x2F;\n\n# This is the name of the job. You can choose it freely.\nmaven_build:\n# A job is always executed within a stage. If no stage is set, it defaults to &#39;test&#39;\nstage: build\n# Since we require Maven for this job, we can restrict the job to runners with a certain tag. Of course, we need to configure a runner with the tag maven with a maven installation\ntags:\n- dev\n# 使用当前作业的名称和当前分支或标签（仅包括二进制文件目录）创建档案\nartifacts:\nname: &quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;\nexpire_in: 4 week\npaths:\n- target&#x2F;*.jar\n# Here you can execute arbitrate terminal commands.\n# If any of the commands returns a non zero exit code the job fails\nscript:\n- echo &quot;Building project with maven&quot;\n- mvn $MAVEN_CLI_OPTS clean\n- mvn $MAVEN_CLI_OPTS install\ndeploy_jdk8:\nstage: deploy\ntags:\n- dev\nscript:\n- echo &quot;Deploy....&quot;\n- sh $SHELL_NAME restart\nwhen: on_success\ninterruptible: true\n\ncat_boot_log:\nstage: catLog\ntags:\n- dev\nscript:\n- echo &quot;cat  log....&quot;\n- sh $SHELL_NAME cat\nwhen: on_success\n\nkill_progress:\nstage: kill\ntags:\n- dev\nscript:\n- echo &quot;kill progress&quot;\n- sh $SHELL_NAME stop\nwhen: manual</code></pre>\n\n<img src=\"https://stblogs.oss-cn-chengdu.aliyuncs.com/UTOOLS1577173183588.png\"  />\n\n<p>关于 .gitlab-ci.yml 具体配置更完整的请参考 <strong><a href=\"https://docs.gitlab.com/ee/ci/yaml/\">官方文档</a></strong></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>文中测试项目:  <strong><a href=\"/download/ruoyi-test-dev.zip\">点击下载</a></strong></p></blockquote>\n<p>Article link： <a href=\"https://tqgoblin.site/post/gitlab-cicd/\">https://tqgoblin.site/post/gitlab-cicd/</a> <div align=left> Author：<a href=\"https://www.tqgoblin.site\"> Stephen </a> </div></p>\n","text":"一、环境准备首先需要有一台 GitLab 服务器，然后需要有个项目；这里示例项目以 Spring Boot 项目为例，然后最好有一台专门用来 Build 的机器...","permalink":"/post/gitlab-cicd","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"运维","slug":"运维","count":1,"path":"api/categories/运维.json"}],"tags":[{"name":"GitLab","slug":"GitLab","count":1,"path":"api/tags/GitLab.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87\"><span class=\"toc-text\">一、环境准备</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81GitLab-CI-%E7%AE%80%E4%BB%8B\"><span class=\"toc-text\">二、GitLab CI 简介</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81GitLab%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">三、GitLab搭建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E5%87%86%E5%9F%BA%E7%A1%80%E4%BE%9D%E8%B5%96\"><span class=\"toc-text\">安准基础依赖</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85GitLab\"><span class=\"toc-text\">安装GitLab</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AEGitLab\"><span class=\"toc-text\">配置GitLab</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BF%E9%97%AEGitLab\"><span class=\"toc-text\">启动并访问GitLab</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81GitLab-CI-%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">四、GitLab CI 配置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A2%9E%E5%8A%A0-Runner\"><span class=\"toc-text\">增加 Runner</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#gitlab-runner-%E6%B3%A8%E5%86%8C\"><span class=\"toc-text\">gitlab-runner 注册</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#gitlab-runner-%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">gitlab-runner 使用</span></a></li></ol></li></ol>","author":{"name":"Stephen","slug":"blog-author","avatar":"../img/logo.png","link":"/","description":"Love and Share","socials":{"github":"http://github.com/topstephen","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"Activiti 学习笔记（二）","uid":"77d3e41277be521fb04715814e170fee","slug":"activiti学习笔记(二)","date":"2019-11-25T14:48:00.000Z","updated":"2020-01-04T09:18:04.000Z","comments":true,"path":"api/articles/activiti学习笔记(二).json","keywords":"Stephen web3","cover":"http://yanxuan.nosdn.127.net/1c8d68e9dec35793796ea26cf1f6a419.jpg","text":"一、Activiti 入门体验流程定义Palette（画板）在 eclipse 或 idea 中安装 activiti-designer 插件即可使用，画板中包...","permalink":"/post/activiti学习笔记(二)","photos":[],"count_time":{"symbolsCount":"9.7k","symbolsTime":"9 mins."},"categories":[{"name":"Activiti","slug":"Activiti","count":2,"path":"api/categories/Activiti.json"}],"tags":[{"name":"Activiti","slug":"Activiti","count":2,"path":"api/tags/Activiti.json"}],"author":{"name":"Stephen","slug":"blog-author","avatar":"../img/logo.png","link":"/","description":"Love and Share","socials":{"github":"http://github.com/topstephen","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}