{"title":"Prometheus监控K8S","uid":"efa52dd3078c52d1c106921316828151","slug":"csdn/Prometheus监控K8S","date":"2021-06-16T15:48:13.000Z","updated":"2025-02-17T04:22:34.744Z","comments":true,"path":"api/articles/csdn/Prometheus监控K8S.json","keywords":"Stephen web3","cover":[],"content":"<link rel=\"stylesheet\" href=\"/owl.css\"><link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h2 id=\"一、描述\"><a href=\"#一、描述\" class=\"headerlink\" title=\"一、描述\"></a>一、描述</h2><p>Cadvisor + node-exporter + prometheus + grafana是一套非常流行的Kubernetes监控方案。它们的功能如下:</p>\n<p>- Cadvisor:容器资源监控工具,可以实时监控CPU、内存、存储、网络等容器指标,并暴露Metrics接口。</p>\n<p>- node-exporter:节点级指标导出工具,可以监控节点的CPU、内存、磁盘、网络等指标,并暴露Metrics接口。</p>\n<p>- Prometheus:时间序列数据库和监控报警工具,可以抓取Cadvisor和node-exporter暴露的Metrics接口,存储时序数据,并提供PromQL查询语言进行监控分析和报警。</p>\n<p>- Grafana:图表和Dashboard工具,可以查询Prometheus中的数据,并通过图表的方式直观展示Kubernetes集群的运行指标和状态。</p>\n<h2 id=\"二、监控流程\"><a href=\"#二、监控流程\" class=\"headerlink\" title=\"二、监控流程\"></a>二、监控流程</h2><p>1. 在Kubernetes集群的每个节点安装Cadvisor和node-exporter,用于采集容器和节点级指标数据。</p>\n<p>2. 部署Prometheus,配置抓取Cadvisor和node-exporter的Metrics接口,存储 containers 和 nodes 的时序数据。</p>\n<p>3. 使用Grafana构建监控仪表盘,选择Prometheus作为数据源,编写PromQL查询语句,展示K8S集群的CPU使用率、内存使用率、网络流量等监控指标。</p>\n<p>4. 根据监控结果,可以设置Prometheus的报警规则,当监控指标超过阈值时发送报警信息。这套方案能够全面监控Kubernetes集群的容器和节点,通过Metrics指标和仪表盘直观反映集群状态,并实现自动报警,非常适合K8S环境下微服务应用的稳定运行。</p>\n<p>具体实现方案如下:</p>\n<p>- Cadvisor:在集群中每个节点作为DaemonSet部署cadvisor,采集容器Metrics。</p>\n<p>- node-exporter:在每个节点也作为DaemonSet运行,采集节点Metrics。</p>\n<p>- Prometheus:部署Prometheus Operator实现,作为Deployment运行,用于抓取Metrics和报警。</p>\n<p>- Grafana:部署Grafana Operator实现,用于仪表盘展示。</p>\n<h2 id=\"三、Kubernetes监控指标\"><a href=\"#三、Kubernetes监控指标\" class=\"headerlink\" title=\"三、Kubernetes监控指标\"></a>三、Kubernetes监控指标</h2><p>K8S本身的监控指标</p>\n<p>1. CPU利用率:包括节点CPU利用率、Pod CPU利用率、容器CPU利用率等,用于监控CPU资源使用情况。</p>\n<p>2. 内存利用率:包括节点内存利用率、Pod内存利用率、容器内存利用率等,用于监控内存资源使用情况。</p>\n<p>3. 网络流量:节点网络流量、Pod网络流量、容器网络流量,用于监控网络收发包大小和带宽利用率。</p>\n<p>4. 磁盘使用率:节点磁盘使用率,用于监控节点磁盘空间使用情况。</p>\n<p>5. Pod状态:Pod的Running、Waiting、Succeeded、Failed等状态数量,用于监控Pod运行状态。</p>\n<p>6. 节点状态:节点的Ready、NotReady和Unreachable状态数量,用于监控节点运行状态。</p>\n<p>7. 容器重启次数:单个容器或Pod内所有容器的重启次数,用于监控容器稳定性。</p>\n<p>8. API服务指标:Kubernetes API Server的请求LATENCY、请求QPS、错误码数量等,用于监控API Server性能。</p>\n<p>9. 集群组件指标:etcd、kubelet、kube-proxy等组件的运行指标,用于监控组件运行状态。这些都是Kubernetes集群运行状态的关键指标,通过Prometheus等工具可以进行收集和存储,然后在Grafana中设计相应的Dashboard进行可视化展示。当这些指标超出正常范围时,也可以根据阈值设置报警,保证Kubernetes集群和服务的稳定运行。</p>\n<p>例如:</p>\n<p>- CPU利用率超过80%报警</p>\n<p>- 内存利用率超过90%报警</p>\n<p>- 网络流量&#x2F;磁盘空间突增报警</p>\n<p>- Pod&#x2F;节点 NotReady状态超过10%报警 </p>\n<p>- API Server请求LATENCY超过200ms报警</p>\n<p>- etcd节点Down报警等等。</p>\n<p>这些报警规则的设置需要根据集群大小和服务负载进行评估。</p>\n<h2 id=\"四、使用Prometheus监控k8s\"><a href=\"#四、使用Prometheus监控k8s\" class=\"headerlink\" title=\"四、使用Prometheus监控k8s\"></a>四、使用Prometheus监控k8s</h2><p>部署前准备</p>\n<p>下载prometheus、grafana、node-exporter</p>\n<p><a href=\"https://github.com/redhatxl/k8s-prometheus-grafana.git\" title=\"GitHub - redhatxl/k8s-prometheus-grafana: k8s monitor of prometheus-grafana\">GitHub - redhatxl&#x2F;k8s-prometheus-grafana: k8s monitor of prometheus-grafanak8s monitor of prometheus-grafana. Contribute to redhatxl&#x2F;k8s-prometheus-grafana development by creating an account on GitHub.<img src=\"https://i-blog.csdnimg.cn/blog_migrate/003a2ce7eb50c2e24a8c624c260c5930.png\" alt=\"icon-default.png?t=N7T8\">https://github.com/redhatxl/k8s-prometheus-grafana.git</a>  \n </p>\n<p> 这里我下载下来上传了该附件，可自行下载</p>\n<p><a href=\"https://download.csdn.net/download/qq_40322236/87918488\">https://download.csdn.net/download/qq_40322236/87918488</a></p>\n<p>拉去镜像：</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master </span><span style=\"color: #89DDFF\">~]</span><span style=\"color: #BABED8\"># docker pull prom/node-exporter </span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master </span><span style=\"color: #89DDFF\">~]</span><span style=\"color: #BABED8\"># docker pull prom/prometheus:v2.0.0</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master </span><span style=\"color: #89DDFF\">~]</span><span style=\"color: #BABED8\"># docker pull grafana/grafana:6.1.4</span></span></code></pre></div><p>解压zip得到如下</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># ls</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">k8s-prometheus-grafana-master</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">k8s-prometheus-grafana-master.zip</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># cd k8s-prometheus-grafana-master/</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># ls</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">grafana</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">node-exporter.yaml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">prometheus</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">README.md</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># ll</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">总用量</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">8</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">drwxr-xr-x</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\">  </span><span style=\"color: #F78C6C\">81</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">月</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">2019</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">grafana</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">-rw-r--r--</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">714</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #C3E88D\">月</span><span style=\"color: #BABED8\">  </span><span style=\"color: #F78C6C\">13</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">:29</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">node-exporter.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">drwxr-xr-x</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">106</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">月</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">2019</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">prometheus</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">-rw-r--r--</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">root</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">117</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #C3E88D\">月</span><span style=\"color: #BABED8\">  </span><span style=\"color: #F78C6C\">13</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">:29</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">README.md</span></span></code></pre></div><p>先安装node-exporter.yaml</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f node-exporter.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">daemonset.apps/node-exporter</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">service/node-exporter</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl get pods -A</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">NAMESPACE</span><span style=\"color: #BABED8\">       </span><span style=\"color: #C3E88D\">NAME</span><span style=\"color: #BABED8\">                                        </span><span style=\"color: #C3E88D\">READY</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">STATUS</span><span style=\"color: #BABED8\">    </span><span style=\"color: #C3E88D\">RESTARTS</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">AGE</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">coredns-9d85f5447-7nhgv</span><span style=\"color: #BABED8\">                     </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">5</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">coredns-9d85f5447-sfr9j</span><span style=\"color: #BABED8\">                     </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">5</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">etcd-master</span><span style=\"color: #BABED8\">                                 </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-apiserver-master</span><span style=\"color: #BABED8\">                       </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-controller-manager-master</span><span style=\"color: #BABED8\">              </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-flannel-ds-77w47</span><span style=\"color: #BABED8\">                       </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">4</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-flannel-ds-trrcv</span><span style=\"color: #BABED8\">                       </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-flannel-ds-xcqgs</span><span style=\"color: #BABED8\">                       </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">4</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-proxy-674k4</span><span style=\"color: #BABED8\">                            </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">4</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-proxy-7l9bk</span><span style=\"color: #BABED8\">                            </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">6</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-proxy-kd449</span><span style=\"color: #BABED8\">                            </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">4</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-scheduler-master</span><span style=\"color: #BABED8\">                       </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">metrics-server-59d984f5b7-2nt8z</span><span style=\"color: #BABED8\">             </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #C3E88D\">/2</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">8</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">node-exporter-5swxx</span><span style=\"color: #BABED8\">                         </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">node-exporter-pbx6c</span><span style=\"color: #BABED8\">                         </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #C3E88D\">/1</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">Running</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #BABED8\">          </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl get daemonset -A</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">NAMESPACE</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">NAME</span><span style=\"color: #BABED8\">              </span><span style=\"color: #C3E88D\">DESIRED</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">CURRENT</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">READY</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">UP-TO-DATE</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">AVAILABLE</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">NODE</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">SELECTOR</span><span style=\"color: #BABED8\">                 </span><span style=\"color: #C3E88D\">AGE</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">kube-flannel-ds</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">       </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">            </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">           </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C3E88D\">non</span><span style=\"color: #BABED8\">e</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\">                        </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">kube-proxy</span><span style=\"color: #BABED8\">        </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">       </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">            </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #BABED8\">           </span><span style=\"color: #C3E88D\">beta.kubernetes.io/os=linux</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">node-exporter</span><span style=\"color: #BABED8\">     </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\">         </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\">       </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\">            </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #BABED8\">           </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C3E88D\">non</span><span style=\"color: #BABED8\">e</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\">                        </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl get service -A</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">NAMESPACE</span><span style=\"color: #BABED8\">       </span><span style=\"color: #C3E88D\">NAME</span><span style=\"color: #BABED8\">             </span><span style=\"color: #C3E88D\">TYPE</span><span style=\"color: #BABED8\">        </span><span style=\"color: #C3E88D\">CLUSTER-IP</span><span style=\"color: #BABED8\">       </span><span style=\"color: #C3E88D\">EXTERNAL-IP</span><span style=\"color: #BABED8\">   </span><span style=\"color: #C3E88D\">PORT</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">S</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\">                                        </span><span style=\"color: #C3E88D\">AGE</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">default</span><span style=\"color: #BABED8\">         </span><span style=\"color: #C3E88D\">kubernetes</span><span style=\"color: #BABED8\">       </span><span style=\"color: #C3E88D\">ClusterIP</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">10.96</span><span style=\"color: #C3E88D\">.0.1</span><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C3E88D\">non</span><span style=\"color: #BABED8\">e</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\">        </span><span style=\"color: #F78C6C\">443</span><span style=\"color: #C3E88D\">/TCP</span><span style=\"color: #BABED8\">                                        </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span><span style=\"color: #BABED8\">                              </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">kube-dns</span><span style=\"color: #BABED8\">         </span><span style=\"color: #C3E88D\">ClusterIP</span><span style=\"color: #BABED8\">   </span><span style=\"color: #F78C6C\">10.96</span><span style=\"color: #C3E88D\">.0.10</span><span style=\"color: #BABED8\">       </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C3E88D\">non</span><span style=\"color: #BABED8\">e</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\">        </span><span style=\"color: #F78C6C\">53</span><span style=\"color: #C3E88D\">/UDP,53/TCP,9153/TCP</span><span style=\"color: #BABED8\">                         </span><span style=\"color: #F78C6C\">22</span><span style=\"color: #C3E88D\">d</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">kube-system</span><span style=\"color: #BABED8\">     </span><span style=\"color: #C3E88D\">node-exporter</span><span style=\"color: #BABED8\">    </span><span style=\"color: #C3E88D\">NodePort</span><span style=\"color: #BABED8\">    </span><span style=\"color: #F78C6C\">10.102</span><span style=\"color: #C3E88D\">.164.149</span><span style=\"color: #BABED8\">   </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C3E88D\">non</span><span style=\"color: #BABED8\">e</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\">        </span><span style=\"color: #F78C6C\">9100</span><span style=\"color: #C3E88D\">:31672/TCP</span><span style=\"color: #BABED8\">                                 </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span><span style=\"color: #BABED8\">                                 </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #C3E88D\">d</span></span></code></pre></div><p>部署prometheus</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master k8s-prometheus-grafana-master</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># cd prometheus/</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># ls</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">configmap.yaml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">prometheus.deploy.yml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">prometheus.svc.yml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">rbac-setup.yaml</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f rbac-setup.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">clusterrole.rbac.authorization.k8s.io/prometheus</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">configured</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">serviceaccount/prometheus</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">configured</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">clusterrolebinding.rbac.authorization.k8s.io/prometheus</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">configured</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f configmap.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">configmap/prometheus-config</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">configured</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f prometheus.deploy.yml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">deployment.apps/prometheus</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f prometheus.svc.yml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">service/prometheus</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span></code></pre></div><p>部署grafana</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master prometheus</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># cd ../grafana/</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master grafana</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># ls</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">grafana-deploy.yaml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">grafana-ing.yaml</span><span style=\"color: #BABED8\">  </span><span style=\"color: #C3E88D\">grafana-svc.yaml</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master grafana</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f grafana-deploy.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">deployment.apps/grafana-core</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master grafana</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f grafana-svc.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">service/grafana</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">root@master grafana</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"># kubectl apply -f grafana-ing.yaml</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">ingress.extensions/grafana</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">created</span></span></code></pre></div><p> 查看前面安装的pod和service </p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/08cd48311630e24fad07fe9099749407.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/ab119a5f29b4e20d286c1405ca7b5e4a.png\"></p>\n<p>访问<a href=\"http://192.168.159.180:31672/metrics\">http://192.168.159.180:31672/metrics</a>，这是node-exporter采集的数据</p>\n<p> <img src=\"https://i-blog.csdnimg.cn/blog_migrate/45535766f64d5cabfd3f19fc5e4c4afb.png\"></p>\n<p> 访问prometheus地址<a href=\"http://192.168.159.180:30003/graph\">http://192.168.159.180:30003/graph</a><img src=\"https://i-blog.csdnimg.cn/blog_migrate/2b4ec802e9ffdf915041d7f91e3f5bdb.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/6c55c36a959c995bf4c7a85402001ee4.png\"></p>\n<p>访问grafana的地址<a href=\"http://192.168.159.180:32418/login\">http://192.168.159.180:32418/login</a>，默认用户密码都是admin，登录后会默认让你修改密码</p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/ad0df1ebe87838f6b3765b243d07fa08.png\"></p>\n<p> <img src=\"https://i-blog.csdnimg.cn/blog_migrate/406085299a855ada15a286f000c420a8.png\"></p>\n<p>添加grafana 数据源，选择prometheus </p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/8b58a598db9e2e8a7bca5dbce16d95c3.png\"><img src=\"https://i-blog.csdnimg.cn/blog_migrate/a2d61beacb03cfbe9feece0639b20793.png\"> </p>\n<p> <img src=\"https://i-blog.csdnimg.cn/blog_migrate/ddfff486cf75b3edca8014981e6dddb1.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/3b023939a541692e438f2bf3c4c8363b.png\"> <img src=\"https://i-blog.csdnimg.cn/blog_migrate/865838c081eca029235ff983ff61901a.png\"></p>\n<p> <img src=\"https://i-blog.csdnimg.cn/blog_migrate/c744ab345ea48030b653e04624f0402b.png\"></p>\n<p>把K8S的Dashboard的模板导入</p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/dee1e8e4df37e9a1f6abd15a7daacb06.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/5bd5a57f90ace189d11917baf9ef60f6.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/744970cfc582dd8d6d39131714bf992a.png\"></p>\n<p>导入315模板等待一会,或者可以下载好json文件，然后复制到下面的文本框中，点击load</p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/5e85dfeff7670697c4f10b494535ef4c.png\"></p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/39b70fb1635ae166a8e4bd63a8112efe.png\"></p>\n<p>最后就部署完成啦</p>\n<p><img src=\"https://i-blog.csdnimg.cn/blog_migrate/41926db4ba26ab06f08c6f5239d4371d.png\"></p>\n<p>Article link： <a href=\"https://tqgoblin.site/post/csdn/Prometheus%E7%9B%91%E6%8E%A7K8S/\">https://tqgoblin.site/post/csdn/Prometheus监控K8S/</a> <div align=left> Author：<a href=\"https://www.tqgoblin.site\"> Stephen </a> </div></p>\n","text":"一、描述Cadvisor + node-exporter + prometheus + grafana是一套非常流行的Kubernetes监控方案。它们的功能如...","permalink":"/post/csdn/Prometheus监控K8S","photos":[],"count_time":{"symbolsCount":"7.3k","symbolsTime":"7 mins."},"categories":[{"name":"运维","slug":"运维","count":6,"path":"api/categories/运维.json"}],"tags":[{"name":"kubernetes prometheus","slug":"kubernetes-prometheus","count":1,"path":"api/tags/kubernetes-prometheus.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E6%8F%8F%E8%BF%B0\"><span class=\"toc-text\">一、描述</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81%E7%9B%91%E6%8E%A7%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">二、监控流程</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81Kubernetes%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87\"><span class=\"toc-text\">三、Kubernetes监控指标</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81%E4%BD%BF%E7%94%A8Prometheus%E7%9B%91%E6%8E%A7k8s\"><span class=\"toc-text\">四、使用Prometheus监控k8s</span></a></li></ol>","author":{"name":"Stephen","slug":"blog-author","avatar":"../img/logo.png","link":"/","description":"Love and Share","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"限流的场景和应用","uid":"1088266219777eea7a5e1871adc5dc26","slug":"csdn/限流的场景和应用","date":"2021-06-25T07:36:34.000Z","updated":"2025-02-17T04:22:34.797Z","comments":true,"path":"api/articles/csdn/限流的场景和应用.json","keywords":"Stephen web3","cover":null,"text":"应用场景1. 防止流量过大导致系统崩溃:当流量突然增大时,限流可以确保系统不会因为过大的流量导致资源耗尽和系统崩溃。 2. 防止恶意请求:限流可以用来针对一些恶...","permalink":"/post/csdn/限流的场景和应用","photos":[],"count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"categories":[{"name":"Java","slug":"Java","count":15,"path":"api/categories/Java.json"}],"tags":[{"name":"Java","slug":"Java","count":2,"path":"api/tags/Java.json"}],"author":{"name":"Stephen","slug":"blog-author","avatar":"../img/logo.png","link":"/","description":"Love and Share","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Kubernetes master集群高可用","uid":"b048cd9598c07b92af477eb0e98be3f6","slug":"csdn/Kubernetes master集群高可用","date":"2021-06-01T09:21:12.000Z","updated":"2025-02-17T04:22:34.720Z","comments":true,"path":"api/articles/csdn/Kubernetes master集群高可用.json","keywords":"Stephen web3","cover":null,"text":"实现方案Kubernetes master高可用一般有三种实现方案: 1. kubeadm 高可用安装使用kubeadm工具安装Kubernetes集群。通过增...","permalink":"/post/csdn/Kubernetes master集群高可用","photos":[],"count_time":{"symbolsCount":"7.7k","symbolsTime":"7 mins."},"categories":[{"name":"运维","slug":"运维","count":6,"path":"api/categories/运维.json"}],"tags":[{"name":"kubernetes 容器","slug":"kubernetes-容器","count":1,"path":"api/tags/kubernetes-容器.json"}],"author":{"name":"Stephen","slug":"blog-author","avatar":"../img/logo.png","link":"/","description":"Love and Share","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}